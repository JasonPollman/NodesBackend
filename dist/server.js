'use strict';Object.defineProperty(exports, "__esModule", { value: true });var _bluebird = require('bluebird');var _bluebird2 = _interopRequireDefault(_bluebird);exports.































defaultServer = defaultServer;exports.


















onNewSocketConnection = onNewSocketConnection;var _lodash = require('lodash');var _lodash2 = _interopRequireDefault(_lodash);var _http = require('http');var _http2 = _interopRequireDefault(_http);var _debug = require('debug');var _debug2 = _interopRequireDefault(_debug);var _socket = require('socket.io');var _socket2 = _interopRequireDefault(_socket);var _express = require('express');var _express2 = _interopRequireDefault(_express);var _constants = require('./constants');function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function _objectWithoutProperties(obj, keys) {var target = {};for (var i in obj) {if (keys.indexOf(i) >= 0) continue;if (!Object.prototype.hasOwnProperty.call(obj, i)) continue;target[i] = obj[i];}return target;}function _asyncToGenerator(fn) {return function () {var gen = fn.apply(this, arguments);return new _bluebird2.default(function (resolve, reject) {function step(key, arg) {try {var info = gen[key](arg);var value = info.value;} catch (error) {reject(error);return;}if (info.done) {resolve(value);} else {return (0, _bluebird.resolve)(value).then(function (value) {step("next", value);}, function (err) {step("throw", err);});}}return step("next");});};} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Handles and manages the websocket connection.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @since 4/9/18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  */var log = (0, _debug2.default)('node-factory:websockets'); /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Invokes once the default server is listening.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @param {object} data Data containing the server and the server's resolution method.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @returns {undefined}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                */var onServerListening = function onServerListening(_ref) {var server = _ref.server,resolve = _ref.resolve;return function () {var _server$address = server.address(),port = _server$address.port,address = _server$address.address;log('Server listening @ ' + address + ':' + port);resolve(server);};}; /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * Creates a default server if the user doesn't supply one to index.js.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * All standard HTTP requests will send back 401.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @returns {http.Server} An http server instance.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @export
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             */function defaultServer() {var _ref2 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},_ref2$port = _ref2.port,port = _ref2$port === undefined ? _constants.DEFAULT_PORT : _ref2$port;return new _bluebird2.default(function (resolve, reject) {var app = (0, _express2.default)();var server = _http2.default.Server(app);app.use(function (request, response) {return response.status(401).send('Unauthorized');});server.on('error', reject).on('listening', onServerListening({ server: server, resolve: resolve })).listen(port);});} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * Called when a new socket connects.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * @param {object} socket The socket handle that's just connected.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * @returns {undefined}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 */function onNewSocketConnection(socket) {log('New socket connected', _lodash2.default.get(socket, 'handshake.address'));} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * Starts the websockets server.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param {object} options Server options.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param {object} options.server The http server to use. If unsupplied, one will be created.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param {number} options.port The port to start the server on.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @param {function} options.onSocketConnection Called on each new socket connection.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             * @returns {undefined}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             */exports.default = function () {var _ref3 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {var _ref4 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},httpServer = _ref4.httpServer,_ref4$onSocketConnect = _ref4.onSocketConnection,onSocketConnection = _ref4$onSocketConnect === undefined ? _lodash2.default.noop : _ref4$onSocketConnect,options = _objectWithoutProperties(_ref4, ['httpServer', 'onSocketConnection']);var server, websockets;return regeneratorRuntime.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:_context.t0 = httpServer;if (_context.t0) {_context.next = 5;break;}_context.next = 4;return defaultServer(options);case 4:_context.t0 = _context.sent;case 5:server = _context.t0;websockets = (0, _socket2.default)(server);websockets.on('connection', onNewSocketConnection);websockets.on('connection', _lodash2.default.partial(onSocketConnection, websockets, _lodash2.default));return _context.abrupt('return', { server: server,
              websockets: websockets });case 10:case 'end':return _context.stop();}}}, _callee, this);}));function serve() {return _ref3.apply(this, arguments);}return serve;}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zZXJ2ZXIuanMiXSwibmFtZXMiOlsiZGVmYXVsdFNlcnZlciIsIm9uTmV3U29ja2V0Q29ubmVjdGlvbiIsImxvZyIsIm9uU2VydmVyTGlzdGVuaW5nIiwic2VydmVyIiwicmVzb2x2ZSIsImFkZHJlc3MiLCJwb3J0IiwicmVqZWN0IiwiYXBwIiwiU2VydmVyIiwidXNlIiwicmVxdWVzdCIsInJlc3BvbnNlIiwic3RhdHVzIiwic2VuZCIsIm9uIiwibGlzdGVuIiwic29ja2V0IiwiZ2V0IiwiaHR0cFNlcnZlciIsIm9uU29ja2V0Q29ubmVjdGlvbiIsIm5vb3AiLCJvcHRpb25zIiwid2Vic29ja2V0cyIsInBhcnRpYWwiLCJzZXJ2ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFnQ2dCQSxhLEdBQUFBLGE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFtQkFDLHFCLEdBQUFBLHFCLENBN0NoQixnQywrQ0FDQSw0QiwyQ0FDQSw4Qiw2Q0FDQSxtQywrQ0FDQSxrQyxpREFDQSx3QyxxdkJBWEE7Ozs7b3RDQWFBLElBQU1DLE1BQU0scUJBQU0seUJBQU4sQ0FBWixDLENBRUE7Ozs7a3hDQUtBLElBQU1DLG9CQUFvQixTQUFwQkEsaUJBQW9CLFlBQUdDLE1BQUgsUUFBR0EsTUFBSCxDQUFXQyxPQUFYLFFBQVdBLE9BQVgsUUFBeUIsWUFBTSx1QkFDN0JELE9BQU9FLE9BQVAsRUFENkIsQ0FDL0NDLElBRCtDLG1CQUMvQ0EsSUFEK0MsQ0FDekNELE9BRHlDLG1CQUN6Q0EsT0FEeUMsQ0FFdkRKLDRCQUEwQkksT0FBMUIsU0FBcUNDLElBQXJDLEVBQ0FGLFFBQVFELE1BQVIsRUFDRCxDQUp5QixFQUExQixDLENBTUE7Ozs7OytqREFNTyxTQUFTSixhQUFULEdBQXFELGlGQUFKLEVBQUksb0JBQTVCTyxJQUE0QixDQUE1QkEsSUFBNEIsbUVBQzFELE9BQU8sdUJBQVksVUFBQ0YsT0FBRCxFQUFVRyxNQUFWLEVBQXFCLENBQ3RDLElBQU1DLE1BQU0sd0JBQVosQ0FDQSxJQUFNTCxTQUFTLGVBQUtNLE1BQUwsQ0FBWUQsR0FBWixDQUFmLENBRUFBLElBQUlFLEdBQUosQ0FBUSxVQUFDQyxPQUFELEVBQVVDLFFBQVYsVUFBdUJBLFNBQVNDLE1BQVQsQ0FBZ0IsR0FBaEIsRUFBcUJDLElBQXJCLENBQTBCLGNBQTFCLENBQXZCLEVBQVIsRUFFQVgsT0FDR1ksRUFESCxDQUNNLE9BRE4sRUFDZVIsTUFEZixFQUVHUSxFQUZILENBRU0sV0FGTixFQUVtQmIsa0JBQWtCLEVBQUVDLGNBQUYsRUFBVUMsZ0JBQVYsRUFBbEIsQ0FGbkIsRUFHR1ksTUFISCxDQUdVVixJQUhWLEVBSUQsQ0FWTSxDQUFQLENBV0QsQyxDQUVEOzs7O21tRUFLTyxTQUFTTixxQkFBVCxDQUErQmlCLE1BQS9CLEVBQXVDLENBQzVDaEIsSUFBSSxzQkFBSixFQUE0QixpQkFBRWlCLEdBQUYsQ0FBTUQsTUFBTixFQUFjLG1CQUFkLENBQTVCLEVBQ0QsQyxDQUVEOzs7Ozs7O2swRUFRZSxvR0FJWCxFQUpXLENBQ2JFLFVBRGEsU0FDYkEsVUFEYSwrQkFFYkMsa0JBRmEsQ0FFYkEsa0JBRmEseUNBRVEsaUJBQUVDLElBRlYseUJBR1ZDLE9BSFUsb09BS0VILFVBTEYscUVBS3NCcEIsY0FBY3VCLE9BQWQsQ0FMdEIsMkNBS1BuQixNQUxPLGVBTVBvQixVQU5PLEdBTU0sc0JBQUdwQixNQUFILENBTk4sQ0FRYm9CLFdBQVdSLEVBQVgsQ0FBYyxZQUFkLEVBQTRCZixxQkFBNUIsRUFDQXVCLFdBQVdSLEVBQVgsQ0FBYyxZQUFkLEVBQTRCLGlCQUFFUyxPQUFGLENBQVVKLGtCQUFWLEVBQThCRyxVQUE5QixtQkFBNUIsRUFUYSxpQ0FXTixFQUNMcEIsY0FESztBQUVMb0Isb0NBRkssRUFYTSxpRSxZQUFlRSxLLGdEQUFBQSxLIiwiZmlsZSI6InNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSGFuZGxlcyBhbmQgbWFuYWdlcyB0aGUgd2Vic29ja2V0IGNvbm5lY3Rpb24uXG4gKiBAc2luY2UgNC85LzE4XG4gKiBAZmlsZVxuICovXG5cbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgaW8gZnJvbSAnc29ja2V0LmlvJztcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgREVGQVVMVF9QT1JUIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBsb2cgPSBkZWJ1Zygnbm9kZS1mYWN0b3J5OndlYnNvY2tldHMnKTtcblxuLyoqXG4gKiBJbnZva2VzIG9uY2UgdGhlIGRlZmF1bHQgc2VydmVyIGlzIGxpc3RlbmluZy5cbiAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIERhdGEgY29udGFpbmluZyB0aGUgc2VydmVyIGFuZCB0aGUgc2VydmVyJ3MgcmVzb2x1dGlvbiBtZXRob2QuXG4gKiBAcmV0dXJucyB7dW5kZWZpbmVkfVxuICovXG5jb25zdCBvblNlcnZlckxpc3RlbmluZyA9ICh7IHNlcnZlciwgcmVzb2x2ZSB9KSA9PiAoKSA9PiB7XG4gIGNvbnN0IHsgcG9ydCwgYWRkcmVzcyB9ID0gc2VydmVyLmFkZHJlc3MoKTtcbiAgbG9nKGBTZXJ2ZXIgbGlzdGVuaW5nIEAgJHthZGRyZXNzfToke3BvcnR9YCk7XG4gIHJlc29sdmUoc2VydmVyKTtcbn07XG5cbi8qKlxuICogQ3JlYXRlcyBhIGRlZmF1bHQgc2VydmVyIGlmIHRoZSB1c2VyIGRvZXNuJ3Qgc3VwcGx5IG9uZSB0byBpbmRleC5qcy5cbiAqIEFsbCBzdGFuZGFyZCBIVFRQIHJlcXVlc3RzIHdpbGwgc2VuZCBiYWNrIDQwMS5cbiAqIEByZXR1cm5zIHtodHRwLlNlcnZlcn0gQW4gaHR0cCBzZXJ2ZXIgaW5zdGFuY2UuXG4gKiBAZXhwb3J0XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkZWZhdWx0U2VydmVyKHsgcG9ydCA9IERFRkFVTFRfUE9SVCB9ID0ge30pIHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gICAgY29uc3Qgc2VydmVyID0gaHR0cC5TZXJ2ZXIoYXBwKTtcblxuICAgIGFwcC51c2UoKHJlcXVlc3QsIHJlc3BvbnNlKSA9PiByZXNwb25zZS5zdGF0dXMoNDAxKS5zZW5kKCdVbmF1dGhvcml6ZWQnKSk7XG5cbiAgICBzZXJ2ZXJcbiAgICAgIC5vbignZXJyb3InLCByZWplY3QpXG4gICAgICAub24oJ2xpc3RlbmluZycsIG9uU2VydmVyTGlzdGVuaW5nKHsgc2VydmVyLCByZXNvbHZlIH0pKVxuICAgICAgLmxpc3Rlbihwb3J0KTtcbiAgfSk7XG59XG5cbi8qKlxuICogQ2FsbGVkIHdoZW4gYSBuZXcgc29ja2V0IGNvbm5lY3RzLlxuICogQHBhcmFtIHtvYmplY3R9IHNvY2tldCBUaGUgc29ja2V0IGhhbmRsZSB0aGF0J3MganVzdCBjb25uZWN0ZWQuXG4gKiBAcmV0dXJucyB7dW5kZWZpbmVkfVxuICovXG5leHBvcnQgZnVuY3Rpb24gb25OZXdTb2NrZXRDb25uZWN0aW9uKHNvY2tldCkge1xuICBsb2coJ05ldyBzb2NrZXQgY29ubmVjdGVkJywgXy5nZXQoc29ja2V0LCAnaGFuZHNoYWtlLmFkZHJlc3MnKSk7XG59XG5cbi8qKlxuICogU3RhcnRzIHRoZSB3ZWJzb2NrZXRzIHNlcnZlci5cbiAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIFNlcnZlciBvcHRpb25zLlxuICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMuc2VydmVyIFRoZSBodHRwIHNlcnZlciB0byB1c2UuIElmIHVuc3VwcGxpZWQsIG9uZSB3aWxsIGJlIGNyZWF0ZWQuXG4gKiBAcGFyYW0ge251bWJlcn0gb3B0aW9ucy5wb3J0IFRoZSBwb3J0IHRvIHN0YXJ0IHRoZSBzZXJ2ZXIgb24uXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBvcHRpb25zLm9uU29ja2V0Q29ubmVjdGlvbiBDYWxsZWQgb24gZWFjaCBuZXcgc29ja2V0IGNvbm5lY3Rpb24uXG4gKiBAcmV0dXJucyB7dW5kZWZpbmVkfVxuICovXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBzZXJ2ZSh7XG4gIGh0dHBTZXJ2ZXIsXG4gIG9uU29ja2V0Q29ubmVjdGlvbiA9IF8ubm9vcCxcbiAgLi4ub3B0aW9uc1xufSA9IHt9KSB7XG4gIGNvbnN0IHNlcnZlciA9IGh0dHBTZXJ2ZXIgfHwgYXdhaXQgZGVmYXVsdFNlcnZlcihvcHRpb25zKTtcbiAgY29uc3Qgd2Vic29ja2V0cyA9IGlvKHNlcnZlcik7XG5cbiAgd2Vic29ja2V0cy5vbignY29ubmVjdGlvbicsIG9uTmV3U29ja2V0Q29ubmVjdGlvbik7XG4gIHdlYnNvY2tldHMub24oJ2Nvbm5lY3Rpb24nLCBfLnBhcnRpYWwob25Tb2NrZXRDb25uZWN0aW9uLCB3ZWJzb2NrZXRzLCBfKSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzZXJ2ZXIsXG4gICAgd2Vic29ja2V0cyxcbiAgfTtcbn1cbiJdfQ==