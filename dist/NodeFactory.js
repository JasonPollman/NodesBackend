'use strict';Object.defineProperty(exports, "__esModule", { value: true });exports.get = exports.del = exports.set = undefined;var _bluebird = require('bluebird');var _bluebird2 = _interopRequireDefault(_bluebird);






































/**
                                                                                                                                                                                                                        * Sets a new node.
                                                                                                                                                                                                                        * @param {object} factoryOptions Options used to create this operations instance.
                                                                                                                                                                                                                        * @param {object} data The node data to store in the database.
                                                                                                                                                                                                                        * @returns {Promise} Resolves once the node has been created.
                                                                                                                                                                                                                        * @export
                                                                                                                                                                                                                        */var set = exports.set = function () {var _ref3 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(
  function _callee(_ref2) {var store = _ref2.store;var _ref4 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] :




    {},_ref4$id = _ref4.id,id = _ref4$id === undefined ? (0, _v2.default)() : _ref4$id,type = _ref4.type,value = _ref4.value,_ref4$parent = _ref4.parent,parent = _ref4$parent === undefined ? null : _ref4$parent;var node, hasParentNode, isExistingNode, shouldUpsertNode;return regeneratorRuntime.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
            node = validateNode({
              id: id,
              type: type,
              value: value,
              parent: parent });


            // Validate that the parent node exists (if not attaching to the root node).
            // If the parent node doesn't exist, we cannot upsert.
            // Use id: constants.ROOT_NODE_ID for the root node.
            _context.t0 = parent === _constants.ROOT_NODE_ID;if (_context.t0) {_context.next = 6;break;}_context.next = 5;return store.has(node.parent);case 5:_context.t0 = _context.sent;case 6:hasParentNode = _context.t0;if (
            hasParentNode) {_context.next = 9;break;}throw new Error("Cannot upsert node, since its parent node doesn't exist.");case 9:_context.next = 11;return (






              store.get(id));case 11:isExistingNode = _context.sent;
            shouldUpsertNode = isExistingNode ? !_lodash2.default.isEqual(isExistingNode, node) : true;if (!

            shouldUpsertNode) {_context.next = 18;break;}_context.next = 16;return (
              store.set(id, node));case 16:
            log('Upserted node with id', id);return _context.abrupt('return',

            {
              node: node,
              broadcast: true });case 18:



            log('No changes to node with id ' + id + ', soft aborting upsert.');return _context.abrupt('return',

            {
              node: node,
              broadcast: false });case 20:case 'end':return _context.stop();}}}, _callee, this);}));return function set(_x2) {return _ref3.apply(this, arguments);};}();



/**
                                                                                                                                                                          * Deletes a new node.
                                                                                                                                                                          * This will soft fail if the node to delete doesn't exist.
                                                                                                                                                                          * @param {object} factoryOptions Options used to create this operations instance.
                                                                                                                                                                          * @param {object} data The node data to use to delete the node, `id` is required.
                                                                                                                                                                          * @returns {Promise} Resolves once the node has been deleted.
                                                                                                                                                                          * @export
                                                                                                                                                                          */var del = exports.del = function () {var _ref6 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(
  function _callee2(_ref5) {var store = _ref5.store;var _ref7 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},id = _ref7.id;var node;return regeneratorRuntime.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:_context2.next = 2;return (
              store.get(id));case 2:node = _context2.sent;if (!

            node) {_context2.next = 7;break;}_context2.next = 6;return (
              store.del(node.id));case 6:
            log('Deleted node with id', id);case 7:return _context2.abrupt('return',


            {
              node: node,
              broadcast: Boolean(node) });case 8:case 'end':return _context2.stop();}}}, _callee2, this);}));return function del(_x4) {return _ref6.apply(this, arguments);};}();



/**
                                                                                                                                                                                   * Gets a node by id.
                                                                                                                                                                                   * Deliberately made this method async, so it's the same as the rest (since it simply uses a map).
                                                                                                                                                                                   * @param {object} factoryOptions Options used to create this operations instance.
                                                                                                                                                                                   * @param {object} data The node data to use to fetch the node, `id` is required.
                                                                                                                                                                                   * @returns {Promise} Resolves with the node with the given id, or null if it doesn't exist.
                                                                                                                                                                                   * @export
                                                                                                                                                                                   */var get = exports.get = function () {var _ref9 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(
  function _callee3(_ref8) {var store = _ref8.store;var _ref10 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},id = _ref10.id;var node;return regeneratorRuntime.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:_context3.next = 2;return (
              store.get(id));case 2:_context3.t0 = _context3.sent;if (_context3.t0) {_context3.next = 5;break;}_context3.t0 = null;case 5:node = _context3.t0;
            log('Fetched node:', node);return _context3.abrupt('return',

            {
              node: node,
              broadcast: false });case 8:case 'end':return _context3.stop();}}}, _callee3, this);}));return function get(_x6) {return _ref9.apply(this, arguments);};}();



/**
                                                                                                                                                                           * Exports all nodes.
                                                                                                                                                                           * @param {object} factoryOptions Options used to create this operations instance.
                                                                                                                                                                           */exports.
all = all;exports.default =








NodeFactory;var _lodash = require('lodash');var _lodash2 = _interopRequireDefault(_lodash);var _debug = require('debug');var _debug2 = _interopRequireDefault(_debug);var _v = require('uuid/v4');var _v2 = _interopRequireDefault(_v);var _assert = require('assert');var _assert2 = _interopRequireDefault(_assert);var _constants = require('./constants');function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function _asyncToGenerator(fn) {return function () {var gen = fn.apply(this, arguments);return new _bluebird2.default(function (resolve, reject) {function step(key, arg) {try {var info = gen[key](arg);var value = info.value;} catch (error) {reject(error);return;}if (info.done) {resolve(value);} else {return (0, _bluebird.resolve)(value).then(function (value) {step("next", value);}, function (err) {step("throw", err);});}}return step("next");});};} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * Creates instances of "node operations".
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * These are agnostic of the provided store, but utliitze the store
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * via dependency injection. The default export provides partials bound
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * to the provided store itself.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @since 4/9/18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * @file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                */var log = (0, _debug2.default)('node-factory:operations'); /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * The fields from a node we actually care about.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * Any other junk passed through the socket will be ignored.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              * @type {Array<string>}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              */var NODE_VALID_FIELDS = _lodash2.default.keys(_constants.NODE_SCHEMA); /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Validates a node by checking the required properties, per NODE_SCHEMA, and also
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * omits any extraneous node properties send over the socket we don't care about.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * @param {*} node The node to validate.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */function validateNode(node) {var truncatedNode = _lodash2.default.pick(node, NODE_VALID_FIELDS);_lodash2.default.each(_constants.NODE_SCHEMA, function (_ref, key) {var check = _ref.check,message = _ref.message;return (0, _assert2.default)(check(node[key], node), message);});return truncatedNode;}function all(_ref11) {var store = _ref11.store;return store.data;} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Creates a new "node operations" instance, given factory options.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @param {object} factoryOptions Options used to create this operations instance.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @returns {object} Each of the get, set, and del node operations bound to "factoryOptions".
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */function NodeFactory(factoryOptions) {var operations = { get: get, set: set, del: del, all: all };return _lodash2.default.mapValues(operations, function (action) {return _lodash2.default.partial(action, factoryOptions);});}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Ob2RlRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJzdG9yZSIsImlkIiwidHlwZSIsInZhbHVlIiwicGFyZW50Iiwibm9kZSIsInZhbGlkYXRlTm9kZSIsImhhcyIsImhhc1BhcmVudE5vZGUiLCJFcnJvciIsImdldCIsImlzRXhpc3RpbmdOb2RlIiwic2hvdWxkVXBzZXJ0Tm9kZSIsImlzRXF1YWwiLCJzZXQiLCJsb2ciLCJicm9hZGNhc3QiLCJkZWwiLCJCb29sZWFuIiwiYWxsIiwiTm9kZUZhY3RvcnkiLCJOT0RFX1ZBTElEX0ZJRUxEUyIsImtleXMiLCJ0cnVuY2F0ZWROb2RlIiwicGljayIsImVhY2giLCJrZXkiLCJjaGVjayIsIm1lc3NhZ2UiLCJkYXRhIiwiZmFjdG9yeU9wdGlvbnMiLCJvcGVyYXRpb25zIiwibWFwVmFsdWVzIiwicGFydGlhbCIsImFjdGlvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBdUNBOzs7Ozs7O0FBT08sK0JBQXFCQSxLQUFyQixTQUFxQkEsS0FBckI7Ozs7O0FBS0gsTUFMRyxrQkFDTEMsRUFESyxDQUNMQSxFQURLLDRCQUNBLGtCQURBLFlBRUxDLElBRkssU0FFTEEsSUFGSyxDQUdMQyxLQUhLLFNBR0xBLEtBSEssc0JBSUxDLE1BSkssQ0FJTEEsTUFKSyxnQ0FJSSxJQUpKO0FBTUNDLGdCQU5ELEdBTVFDLGFBQWE7QUFDeEJMLG9CQUR3QjtBQUV4QkMsd0JBRndCO0FBR3hCQywwQkFId0I7QUFJeEJDLDRCQUp3QixFQUFiLENBTlI7OztBQWFMO0FBQ0E7QUFDQTtBQWZLLDBCQWdCaUJBLGtDQWhCakIscUVBZ0JrREosTUFBTU8sR0FBTixDQUFVRixLQUFLRCxNQUFmLENBaEJsRCwyQ0FnQkNJLGFBaEJEO0FBaUJBQSx5QkFqQkEsa0NBaUJxQixJQUFJQyxLQUFKLENBQVUsMERBQVYsQ0FqQnJCOzs7Ozs7O0FBd0J3QlQsb0JBQU1VLEdBQU4sQ0FBVVQsRUFBVixDQXhCeEIsVUF3QkNVLGNBeEJEO0FBeUJDQyw0QkF6QkQsR0F5Qm9CRCxpQkFBaUIsQ0FBQyxpQkFBRUUsT0FBRixDQUFVRixjQUFWLEVBQTBCTixJQUExQixDQUFsQixHQUFvRCxJQXpCeEU7O0FBMkJETyw0QkEzQkM7QUE0QkdaLG9CQUFNYyxHQUFOLENBQVViLEVBQVYsRUFBY0ksSUFBZCxDQTVCSDtBQTZCSFUsZ0JBQUksdUJBQUosRUFBNkJkLEVBQTdCLEVBN0JHOztBQStCSTtBQUNMSSx3QkFESztBQUVMVyx5QkFBVyxJQUZOLEVBL0JKOzs7O0FBcUNMRCxnREFBa0NkLEVBQWxDLDhCQXJDSzs7QUF1Q0U7QUFDTEksd0JBREs7QUFFTFcseUJBQVcsS0FGTixFQXZDRixpRSxtQkFBZUYsRzs7OztBQTZDdEI7Ozs7Ozs7O0FBUU8sZ0NBQXFCZCxLQUFyQixTQUFxQkEsS0FBckIsaUZBQXVDLEVBQXZDLENBQWdDQyxFQUFoQyxTQUFnQ0EsRUFBaEM7QUFDY0Qsb0JBQU1VLEdBQU4sQ0FBVVQsRUFBVixDQURkLFNBQ0NJLElBREQ7O0FBR0RBLGdCQUhDO0FBSUdMLG9CQUFNaUIsR0FBTixDQUFVWixLQUFLSixFQUFmLENBSkg7QUFLSGMsZ0JBQUksc0JBQUosRUFBNEJkLEVBQTVCLEVBTEc7OztBQVFFO0FBQ0xJLHdCQURLO0FBRUxXLHlCQUFXRSxRQUFRYixJQUFSLENBRk4sRUFSRixrRSxtQkFBZVksRzs7OztBQWN0Qjs7Ozs7Ozs7QUFRTyxnQ0FBcUJqQixLQUFyQixTQUFxQkEsS0FBckIsa0ZBQXVDLEVBQXZDLENBQWdDQyxFQUFoQyxVQUFnQ0EsRUFBaEM7QUFDY0Qsb0JBQU1VLEdBQU4sQ0FBVVQsRUFBVixDQURkLG1HQUMrQixJQUQvQixRQUNDSSxJQUREO0FBRUxVLGdCQUFJLGVBQUosRUFBcUJWLElBQXJCLEVBRks7O0FBSUU7QUFDTEEsd0JBREs7QUFFTFcseUJBQVcsS0FGTixFQUpGLGtFLG1CQUFlTixHOzs7O0FBVXRCOzs7O0FBSWdCUyxHLEdBQUFBLEc7Ozs7Ozs7OztBQVNRQyxXLENBdkl4QixnQywrQ0FDQSw4Qiw2Q0FDQSw0QixxQ0FDQSxnQywrQ0FFQSx3QyxpaUJBZEE7Ozs7Ozs7azRCQW1CQSxJQUFNTCxNQUFNLHFCQUFNLHlCQUFOLENBQVosQyxDQUVBOzs7O2c4QkFLQSxJQUFNTSxvQkFBb0IsaUJBQUVDLElBQUYsd0JBQTFCLEMsQ0FFQTs7OzswZ0NBS0EsU0FBU2hCLFlBQVQsQ0FBc0JELElBQXRCLEVBQTRCLENBQzFCLElBQU1rQixnQkFBZ0IsaUJBQUVDLElBQUYsQ0FBT25CLElBQVAsRUFBYWdCLGlCQUFiLENBQXRCLENBQ0EsaUJBQUVJLElBQUYseUJBQW9CLGdCQUFxQkMsR0FBckIsT0FBR0MsS0FBSCxRQUFHQSxLQUFILENBQVVDLE9BQVYsUUFBVUEsT0FBVixRQUE2QixzQkFBT0QsTUFBTXRCLEtBQUtxQixHQUFMLENBQU4sRUFBaUJyQixJQUFqQixDQUFQLEVBQStCdUIsT0FBL0IsQ0FBN0IsRUFBcEIsRUFDQSxPQUFPTCxhQUFQLENBQ0QsQ0FrR00sU0FBU0osR0FBVCxTQUF3QixLQUFUbkIsS0FBUyxVQUFUQSxLQUFTLENBQzdCLE9BQU9BLE1BQU02QixJQUFiLENBQ0QsQyxDQUVEOzs7O3kzQ0FLZSxTQUFTVCxXQUFULENBQXFCVSxjQUFyQixFQUFxQyxDQUNsRCxJQUFNQyxhQUFhLEVBQ2pCckIsUUFEaUIsRUFFakJJLFFBRmlCLEVBR2pCRyxRQUhpQixFQUlqQkUsUUFKaUIsRUFBbkIsQ0FPQSxPQUFPLGlCQUFFYSxTQUFGLENBQVlELFVBQVosRUFBd0IsMEJBQVUsaUJBQUVFLE9BQUYsQ0FBVUMsTUFBVixFQUFrQkosY0FBbEIsQ0FBVixFQUF4QixDQUFQLENBQ0QiLCJmaWxlIjoiTm9kZUZhY3RvcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZXMgaW5zdGFuY2VzIG9mIFwibm9kZSBvcGVyYXRpb25zXCIuXG4gKiBUaGVzZSBhcmUgYWdub3N0aWMgb2YgdGhlIHByb3ZpZGVkIHN0b3JlLCBidXQgdXRsaWl0emUgdGhlIHN0b3JlXG4gKiB2aWEgZGVwZW5kZW5jeSBpbmplY3Rpb24uIFRoZSBkZWZhdWx0IGV4cG9ydCBwcm92aWRlcyBwYXJ0aWFscyBib3VuZFxuICogdG8gdGhlIHByb3ZpZGVkIHN0b3JlIGl0c2VsZi5cbiAqIEBzaW5jZSA0LzkvMThcbiAqIEBmaWxlXG4gKi9cblxuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgdXVpZCBmcm9tICd1dWlkL3Y0JztcbmltcG9ydCBhc3NlcnQgZnJvbSAnYXNzZXJ0JztcblxuaW1wb3J0IHtcbiAgTk9ERV9TQ0hFTUEsXG4gIFJPT1RfTk9ERV9JRCxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBsb2cgPSBkZWJ1Zygnbm9kZS1mYWN0b3J5Om9wZXJhdGlvbnMnKTtcblxuLyoqXG4gKiBUaGUgZmllbGRzIGZyb20gYSBub2RlIHdlIGFjdHVhbGx5IGNhcmUgYWJvdXQuXG4gKiBBbnkgb3RoZXIganVuayBwYXNzZWQgdGhyb3VnaCB0aGUgc29ja2V0IHdpbGwgYmUgaWdub3JlZC5cbiAqIEB0eXBlIHtBcnJheTxzdHJpbmc+fVxuICovXG5jb25zdCBOT0RFX1ZBTElEX0ZJRUxEUyA9IF8ua2V5cyhOT0RFX1NDSEVNQSk7XG5cbi8qKlxuICogVmFsaWRhdGVzIGEgbm9kZSBieSBjaGVja2luZyB0aGUgcmVxdWlyZWQgcHJvcGVydGllcywgcGVyIE5PREVfU0NIRU1BLCBhbmQgYWxzb1xuICogb21pdHMgYW55IGV4dHJhbmVvdXMgbm9kZSBwcm9wZXJ0aWVzIHNlbmQgb3ZlciB0aGUgc29ja2V0IHdlIGRvbid0IGNhcmUgYWJvdXQuXG4gKiBAcGFyYW0geyp9IG5vZGUgVGhlIG5vZGUgdG8gdmFsaWRhdGUuXG4gKi9cbmZ1bmN0aW9uIHZhbGlkYXRlTm9kZShub2RlKSB7XG4gIGNvbnN0IHRydW5jYXRlZE5vZGUgPSBfLnBpY2sobm9kZSwgTk9ERV9WQUxJRF9GSUVMRFMpO1xuICBfLmVhY2goTk9ERV9TQ0hFTUEsICh7IGNoZWNrLCBtZXNzYWdlIH0sIGtleSkgPT4gYXNzZXJ0KGNoZWNrKG5vZGVba2V5XSwgbm9kZSksIG1lc3NhZ2UpKTtcbiAgcmV0dXJuIHRydW5jYXRlZE5vZGU7XG59XG5cbi8qKlxuICogU2V0cyBhIG5ldyBub2RlLlxuICogQHBhcmFtIHtvYmplY3R9IGZhY3RvcnlPcHRpb25zIE9wdGlvbnMgdXNlZCB0byBjcmVhdGUgdGhpcyBvcGVyYXRpb25zIGluc3RhbmNlLlxuICogQHBhcmFtIHtvYmplY3R9IGRhdGEgVGhlIG5vZGUgZGF0YSB0byBzdG9yZSBpbiB0aGUgZGF0YWJhc2UuXG4gKiBAcmV0dXJucyB7UHJvbWlzZX0gUmVzb2x2ZXMgb25jZSB0aGUgbm9kZSBoYXMgYmVlbiBjcmVhdGVkLlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2V0KHsgc3RvcmUgfSwge1xuICBpZCA9IHV1aWQoKSxcbiAgdHlwZSxcbiAgdmFsdWUsXG4gIHBhcmVudCA9IG51bGwsXG59ID0ge30pIHtcbiAgY29uc3Qgbm9kZSA9IHZhbGlkYXRlTm9kZSh7XG4gICAgaWQsXG4gICAgdHlwZSxcbiAgICB2YWx1ZSxcbiAgICBwYXJlbnQsXG4gIH0pO1xuXG4gIC8vIFZhbGlkYXRlIHRoYXQgdGhlIHBhcmVudCBub2RlIGV4aXN0cyAoaWYgbm90IGF0dGFjaGluZyB0byB0aGUgcm9vdCBub2RlKS5cbiAgLy8gSWYgdGhlIHBhcmVudCBub2RlIGRvZXNuJ3QgZXhpc3QsIHdlIGNhbm5vdCB1cHNlcnQuXG4gIC8vIFVzZSBpZDogY29uc3RhbnRzLlJPT1RfTk9ERV9JRCBmb3IgdGhlIHJvb3Qgbm9kZS5cbiAgY29uc3QgaGFzUGFyZW50Tm9kZSA9IHBhcmVudCA9PT0gUk9PVF9OT0RFX0lEIHx8IGF3YWl0IHN0b3JlLmhhcyhub2RlLnBhcmVudCk7XG4gIGlmICghaGFzUGFyZW50Tm9kZSkgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHVwc2VydCBub2RlLCBzaW5jZSBpdHMgcGFyZW50IG5vZGUgZG9lc24ndCBleGlzdC5cIik7XG5cblxuICAvLyBPbmx5IHVwZGF0ZSB0aGUgbm9kZSBpZiBzb21ldGhpbmcgYWJvdXQgaXQgaGFzIGNoYW5nZWQuXG4gIC8vIFRoaXMgd2lsbCBkbyBhIGRlZXAgY29tcGFyZSBvbiB0aGUgbm9kZXMsIGJ1dCBpbiBvdXIgY2FzZVxuICAvLyB0aGUgZGF0YSBzdG9yZSBpcyBzbyBzbWFsbCB0aGlzIGlzIG11Y2ggbW9yZSBlZmZpY2llbnRcbiAgLy8gdGhhbiBtYWtpbmcgYW4gdXBzZXJ0IHJlcXVlc3QgdG8gdGhlIERCIGFzIGEgbm9vcC5cbiAgY29uc3QgaXNFeGlzdGluZ05vZGUgPSBhd2FpdCBzdG9yZS5nZXQoaWQpO1xuICBjb25zdCBzaG91bGRVcHNlcnROb2RlID0gaXNFeGlzdGluZ05vZGUgPyAhXy5pc0VxdWFsKGlzRXhpc3RpbmdOb2RlLCBub2RlKSA6IHRydWU7XG5cbiAgaWYgKHNob3VsZFVwc2VydE5vZGUpIHtcbiAgICBhd2FpdCBzdG9yZS5zZXQoaWQsIG5vZGUpO1xuICAgIGxvZygnVXBzZXJ0ZWQgbm9kZSB3aXRoIGlkJywgaWQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5vZGUsXG4gICAgICBicm9hZGNhc3Q6IHRydWUsXG4gICAgfTtcbiAgfVxuXG4gIGxvZyhgTm8gY2hhbmdlcyB0byBub2RlIHdpdGggaWQgJHtpZH0sIHNvZnQgYWJvcnRpbmcgdXBzZXJ0LmApO1xuXG4gIHJldHVybiB7XG4gICAgbm9kZSxcbiAgICBicm9hZGNhc3Q6IGZhbHNlLFxuICB9O1xufVxuXG4vKipcbiAqIERlbGV0ZXMgYSBuZXcgbm9kZS5cbiAqIFRoaXMgd2lsbCBzb2Z0IGZhaWwgaWYgdGhlIG5vZGUgdG8gZGVsZXRlIGRvZXNuJ3QgZXhpc3QuXG4gKiBAcGFyYW0ge29iamVjdH0gZmFjdG9yeU9wdGlvbnMgT3B0aW9ucyB1c2VkIHRvIGNyZWF0ZSB0aGlzIG9wZXJhdGlvbnMgaW5zdGFuY2UuXG4gKiBAcGFyYW0ge29iamVjdH0gZGF0YSBUaGUgbm9kZSBkYXRhIHRvIHVzZSB0byBkZWxldGUgdGhlIG5vZGUsIGBpZGAgaXMgcmVxdWlyZWQuXG4gKiBAcmV0dXJucyB7UHJvbWlzZX0gUmVzb2x2ZXMgb25jZSB0aGUgbm9kZSBoYXMgYmVlbiBkZWxldGVkLlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsKHsgc3RvcmUgfSwgeyBpZCB9ID0ge30pIHtcbiAgY29uc3Qgbm9kZSA9IGF3YWl0IHN0b3JlLmdldChpZCk7XG5cbiAgaWYgKG5vZGUpIHtcbiAgICBhd2FpdCBzdG9yZS5kZWwobm9kZS5pZCk7XG4gICAgbG9nKCdEZWxldGVkIG5vZGUgd2l0aCBpZCcsIGlkKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbm9kZSxcbiAgICBicm9hZGNhc3Q6IEJvb2xlYW4obm9kZSksXG4gIH07XG59XG5cbi8qKlxuICogR2V0cyBhIG5vZGUgYnkgaWQuXG4gKiBEZWxpYmVyYXRlbHkgbWFkZSB0aGlzIG1ldGhvZCBhc3luYywgc28gaXQncyB0aGUgc2FtZSBhcyB0aGUgcmVzdCAoc2luY2UgaXQgc2ltcGx5IHVzZXMgYSBtYXApLlxuICogQHBhcmFtIHtvYmplY3R9IGZhY3RvcnlPcHRpb25zIE9wdGlvbnMgdXNlZCB0byBjcmVhdGUgdGhpcyBvcGVyYXRpb25zIGluc3RhbmNlLlxuICogQHBhcmFtIHtvYmplY3R9IGRhdGEgVGhlIG5vZGUgZGF0YSB0byB1c2UgdG8gZmV0Y2ggdGhlIG5vZGUsIGBpZGAgaXMgcmVxdWlyZWQuXG4gKiBAcmV0dXJucyB7UHJvbWlzZX0gUmVzb2x2ZXMgd2l0aCB0aGUgbm9kZSB3aXRoIHRoZSBnaXZlbiBpZCwgb3IgbnVsbCBpZiBpdCBkb2Vzbid0IGV4aXN0LlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0KHsgc3RvcmUgfSwgeyBpZCB9ID0ge30pIHtcbiAgY29uc3Qgbm9kZSA9IGF3YWl0IHN0b3JlLmdldChpZCkgfHwgbnVsbDtcbiAgbG9nKCdGZXRjaGVkIG5vZGU6Jywgbm9kZSk7XG5cbiAgcmV0dXJuIHtcbiAgICBub2RlLFxuICAgIGJyb2FkY2FzdDogZmFsc2UsXG4gIH07XG59XG5cbi8qKlxuICogRXhwb3J0cyBhbGwgbm9kZXMuXG4gKiBAcGFyYW0ge29iamVjdH0gZmFjdG9yeU9wdGlvbnMgT3B0aW9ucyB1c2VkIHRvIGNyZWF0ZSB0aGlzIG9wZXJhdGlvbnMgaW5zdGFuY2UuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhbGwoeyBzdG9yZSB9KSB7XG4gIHJldHVybiBzdG9yZS5kYXRhO1xufVxuXG4vKipcbiAqIENyZWF0ZXMgYSBuZXcgXCJub2RlIG9wZXJhdGlvbnNcIiBpbnN0YW5jZSwgZ2l2ZW4gZmFjdG9yeSBvcHRpb25zLlxuICogQHBhcmFtIHtvYmplY3R9IGZhY3RvcnlPcHRpb25zIE9wdGlvbnMgdXNlZCB0byBjcmVhdGUgdGhpcyBvcGVyYXRpb25zIGluc3RhbmNlLlxuICogQHJldHVybnMge29iamVjdH0gRWFjaCBvZiB0aGUgZ2V0LCBzZXQsIGFuZCBkZWwgbm9kZSBvcGVyYXRpb25zIGJvdW5kIHRvIFwiZmFjdG9yeU9wdGlvbnNcIi5cbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gTm9kZUZhY3RvcnkoZmFjdG9yeU9wdGlvbnMpIHtcbiAgY29uc3Qgb3BlcmF0aW9ucyA9IHtcbiAgICBnZXQsXG4gICAgc2V0LFxuICAgIGRlbCxcbiAgICBhbGwsXG4gIH07XG5cbiAgcmV0dXJuIF8ubWFwVmFsdWVzKG9wZXJhdGlvbnMsIGFjdGlvbiA9PiBfLnBhcnRpYWwoYWN0aW9uLCBmYWN0b3J5T3B0aW9ucykpO1xufVxuIl19