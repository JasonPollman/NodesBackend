'use strict';Object.defineProperty(exports, "__esModule", { value: true });var _bluebird = require('bluebird');exports.





























handleNodeEventError = handleNodeEventError;exports.











broadcastChildEvent = broadcastChildEvent;exports.

























prepareNodeOperation = prepareNodeOperation;exports.default =






















setupWebsocketEvents;var _lodash = require('lodash');var _lodash2 = _interopRequireDefault(_lodash);var _util = require('util');var _util2 = _interopRequireDefault(_util);var _debug = require('debug');var _debug2 = _interopRequireDefault(_debug);var _constants = require('./constants');function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}function _defineProperty(obj, key, value) {if (key in obj) {Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true });} else {obj[key] = value;}return obj;} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Exports a function that takes in a NodeFactory instance and returns a method that
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * can be passed to the websockets manager's `onSocketConnection` callback.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * This binds all the socket events to the given NodeFactory instance.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @since 4/9/18
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * @file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */var log = (0, _debug2.default)('node-factory:events'); // eslint-disable-next-line no-console
var inspect = function inspect(value) {return console.log(_util2.default.inspect(value, { colors: true, depth: 10 }));}; /**
                                                                                                                          * Dispatches the error event when any incoming message fails to process.
                                                                                                                          * This event can be hooked into to "toast" error messages on the front-end.
                                                                                                                          * @param {object} socket The socket connection handler in which the error occurred.
                                                                                                                          * @param {string} event The name of the event that failed to process.
                                                                                                                          * @param {Error} error The error that was thrown by the incoming message handler.
                                                                                                                          * @export
                                                                                                                          */function handleNodeEventError(socket, event, error) {log('Socket Handler Error "' + event + '":', error);socket.emit(_constants.SOCKET_EVENTS.ERROR, { event: event, error: error.message });} /**
                                                                                                                                                                                                                                                                                                                            * Broadcasts the message from the user to the rest of the connected clients.
                                                                                                                                                                                                                                                                                                                            * This excludes the client who was the original sender (per socket.io docs).
                                                                                                                                                                                                                                                                                                                            * @param {object} socket The socket connection handler associated with the callback.
                                                                                                                                                                                                                                                                                                                            * @param {string} event The name of the event that callback will be bound to.
                                                                                                                                                                                                                                                                                                                            * @param {object} node The data to emit.
                                                                                                                                                                                                                                                                                                                            */function broadcastChildEvent(socket, event, node) {var key = 'child-of-' + node.parent + '-' + event;log('Broadcasting Socket Event "' + key + '":');socket.broadcast.emit(key, node);log('Broadcasting Socket Event "' + event + '":', node);socket.broadcast.emit(event, node);} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * Prepares an incoming socket event handler by wrapping the event handler to call the respective
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * node operation, broadcast the event to all connected users, and and emit
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * the SOCKET_EVENTS.ERROR event if the handler throws.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * It also limits the interface of each partialized node operation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * to receive only a single object (by design).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param {object} socket The socket connection handler associated with the handler.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param {object} eventSchema Options for this given event.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param {function} eventSchema.handler The event handler that will be invoked on "event".
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param {boolean} eventSchema.broadcast If true, the event will be
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * broadcast to all other connected clients.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @param {string} event The name of the event that handler will be bound to.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @returns {function} The wrapped socket event handler.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  * @export
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  */function prepareNodeOperation(socket, handler, event) {return function (data) {log('Incoming Socket Event "' + event + '":', data);var maybeBroadcastChildEvent = function maybeBroadcastChildEvent(_ref) {var node = _ref.node,broadcast = _ref.broadcast;return broadcast ? broadcastChildEvent(socket, event, node) : _lodash2.default.noop;};return (0, _bluebird.resolve)().then(function () {return handler(data);}).then(maybeBroadcastChildEvent).catch(function (e) {return handleNodeEventError(socket, event, e);});};} /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * Returns a function that can be passed to the websocket's `onSocketConnection`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * callback, provided a NodeFactory instance. This will setup the necessary socket
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * event handlers for each of the corresponding node factory CRUD methods.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * @param {object} nodes The NodeFactory to operate against and to bind to the socket connection.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * @returns {function} A callback for websockets.onSocketConnection.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        * @export
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        */function setupWebsocketEvents(nodes) {return function (websocket, socket) {var _eventSchema; // Convenience to dump the store's data
    // for debugging purposes.
    if (_constants.NODE_ENV !== 'production') socket.on('dump', function () {return inspect(nodes.all());});var eventSchema = (_eventSchema = {}, _defineProperty(_eventSchema, _constants.SOCKET_EVENTS.HAS_NODE, nodes.has), _defineProperty(_eventSchema, _constants.SOCKET_EVENTS.GET_NODE, nodes.get), _defineProperty(_eventSchema, _constants.SOCKET_EVENTS.SET_NODE, nodes.set), _defineProperty(_eventSchema, _constants.SOCKET_EVENTS.DEL_NODE, nodes.del), _eventSchema);_lodash2.default.each(eventSchema, function (schema, event) {socket.on(event, prepareNodeOperation(socket, schema, event));});};}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ldmVudHMuanMiXSwibmFtZXMiOlsiaGFuZGxlTm9kZUV2ZW50RXJyb3IiLCJicm9hZGNhc3RDaGlsZEV2ZW50IiwicHJlcGFyZU5vZGVPcGVyYXRpb24iLCJzZXR1cFdlYnNvY2tldEV2ZW50cyIsImxvZyIsImluc3BlY3QiLCJjb25zb2xlIiwidmFsdWUiLCJjb2xvcnMiLCJkZXB0aCIsInNvY2tldCIsImV2ZW50IiwiZXJyb3IiLCJlbWl0IiwiRVJST1IiLCJtZXNzYWdlIiwibm9kZSIsImtleSIsInBhcmVudCIsImJyb2FkY2FzdCIsImhhbmRsZXIiLCJkYXRhIiwibWF5YmVCcm9hZGNhc3RDaGlsZEV2ZW50Iiwibm9vcCIsInRoZW4iLCJjYXRjaCIsImUiLCJub2RlcyIsIndlYnNvY2tldCIsIm9uIiwiYWxsIiwiZXZlbnRTY2hlbWEiLCJIQVNfTk9ERSIsImhhcyIsIkdFVF9OT0RFIiwiZ2V0IiwiU0VUX05PREUiLCJzZXQiLCJERUxfTk9ERSIsImRlbCIsImVhY2giLCJzY2hlbWEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQThCZ0JBLG9CLEdBQUFBLG9COzs7Ozs7Ozs7Ozs7QUFZQUMsbUIsR0FBQUEsbUI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBMEJBQyxvQixHQUFBQSxvQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1QlFDLG9CLENBbkZ4QixnQywrQ0FDQSw0QiwyQ0FDQSw4Qiw2Q0FFQSx3Qyx3U0FaQTs7Ozs7O3lrQkFpQkEsSUFBTUMsTUFBTSxxQkFBTSxxQkFBTixDQUFaLEMsQ0FFQTtBQUNBLElBQU1DLFVBQVUsU0FBVkEsT0FBVSxnQkFBU0MsUUFBUUYsR0FBUixDQUFZLGVBQUtDLE9BQUwsQ0FBYUUsS0FBYixFQUFvQixFQUFFQyxRQUFRLElBQVYsRUFBZ0JDLE9BQU8sRUFBdkIsRUFBcEIsQ0FBWixDQUFULEVBQWhCLEMsQ0FFQTs7Ozs7Ozs0SEFRTyxTQUFTVCxvQkFBVCxDQUE4QlUsTUFBOUIsRUFBc0NDLEtBQXRDLEVBQTZDQyxLQUE3QyxFQUFvRCxDQUN6RFIsK0JBQTZCTyxLQUE3QixTQUF3Q0MsS0FBeEMsRUFDQUYsT0FBT0csSUFBUCxDQUFZLHlCQUFjQyxLQUExQixFQUFpQyxFQUFFSCxZQUFGLEVBQVNDLE9BQU9BLE1BQU1HLE9BQXRCLEVBQWpDLEVBQ0QsQyxDQUVEOzs7Ozs7OFRBT08sU0FBU2QsbUJBQVQsQ0FBNkJTLE1BQTdCLEVBQXFDQyxLQUFyQyxFQUE0Q0ssSUFBNUMsRUFBa0QsQ0FDdkQsSUFBTUMsb0JBQWtCRCxLQUFLRSxNQUF2QixTQUFpQ1AsS0FBdkMsQ0FFQVAsb0NBQWtDYSxHQUFsQyxTQUNBUCxPQUFPUyxTQUFQLENBQWlCTixJQUFqQixDQUFzQkksR0FBdEIsRUFBMkJELElBQTNCLEVBRUFaLG9DQUFrQ08sS0FBbEMsU0FBNkNLLElBQTdDLEVBQ0FOLE9BQU9TLFNBQVAsQ0FBaUJOLElBQWpCLENBQXNCRixLQUF0QixFQUE2QkssSUFBN0IsRUFDRCxDLENBRUQ7Ozs7Ozs7Ozs7Ozs7OztvbEJBZ0JPLFNBQVNkLG9CQUFULENBQThCUSxNQUE5QixFQUFzQ1UsT0FBdEMsRUFBK0NULEtBQS9DLEVBQXNELENBQzNELE9BQU8sVUFBQ1UsSUFBRCxFQUFVLENBQ2ZqQixnQ0FBOEJPLEtBQTlCLFNBQXlDVSxJQUF6QyxFQUVBLElBQU1DLDJCQUEyQixTQUEzQkEsd0JBQTJCLFlBQUdOLElBQUgsUUFBR0EsSUFBSCxDQUFTRyxTQUFULFFBQVNBLFNBQVQsUUFDL0JBLFlBQVlsQixvQkFBb0JTLE1BQXBCLEVBQTRCQyxLQUE1QixFQUFtQ0ssSUFBbkMsQ0FBWixHQUF1RCxpQkFBRU8sSUFEMUIsRUFBakMsQ0FJQSxPQUFPLHlCQUNKQyxJQURJLENBQ0Msb0JBQU1KLFFBQVFDLElBQVIsQ0FBTixFQURELEVBRUpHLElBRkksQ0FFQ0Ysd0JBRkQsRUFHSkcsS0FISSxDQUdFLHFCQUFLekIscUJBQXFCVSxNQUFyQixFQUE2QkMsS0FBN0IsRUFBb0NlLENBQXBDLENBQUwsRUFIRixDQUFQLENBSUQsQ0FYRCxDQVlELEMsQ0FFRDs7Ozs7OzswbENBUWUsU0FBU3ZCLG9CQUFULENBQThCd0IsS0FBOUIsRUFBcUMsQ0FDbEQsT0FBTyxVQUFDQyxTQUFELEVBQVlsQixNQUFaLEVBQXVCLG1CQUM1QjtBQUNBO0FBQ0EsUUFBSSx3QkFBYSxZQUFqQixFQUErQkEsT0FBT21CLEVBQVAsQ0FBVSxNQUFWLEVBQWtCLG9CQUFNeEIsUUFBUXNCLE1BQU1HLEdBQU4sRUFBUixDQUFOLEVBQWxCLEVBRS9CLElBQU1DLGdFQUNILHlCQUFjQyxRQURYLEVBQ3NCTCxNQUFNTSxHQUQ1QixpQ0FFSCx5QkFBY0MsUUFGWCxFQUVzQlAsTUFBTVEsR0FGNUIsaUNBR0gseUJBQWNDLFFBSFgsRUFHc0JULE1BQU1VLEdBSDVCLGlDQUlILHlCQUFjQyxRQUpYLEVBSXNCWCxNQUFNWSxHQUo1QixnQkFBTixDQU9BLGlCQUFFQyxJQUFGLENBQU9ULFdBQVAsRUFBb0IsVUFBQ1UsTUFBRCxFQUFTOUIsS0FBVCxFQUFtQixDQUNyQ0QsT0FBT21CLEVBQVAsQ0FBVWxCLEtBQVYsRUFBaUJULHFCQUFxQlEsTUFBckIsRUFBNkIrQixNQUE3QixFQUFxQzlCLEtBQXJDLENBQWpCLEVBQ0QsQ0FGRCxFQUdELENBZkQsQ0FnQkQiLCJmaWxlIjoiZXZlbnRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBFeHBvcnRzIGEgZnVuY3Rpb24gdGhhdCB0YWtlcyBpbiBhIE5vZGVGYWN0b3J5IGluc3RhbmNlIGFuZCByZXR1cm5zIGEgbWV0aG9kIHRoYXRcbiAqIGNhbiBiZSBwYXNzZWQgdG8gdGhlIHdlYnNvY2tldHMgbWFuYWdlcidzIGBvblNvY2tldENvbm5lY3Rpb25gIGNhbGxiYWNrLlxuICogVGhpcyBiaW5kcyBhbGwgdGhlIHNvY2tldCBldmVudHMgdG8gdGhlIGdpdmVuIE5vZGVGYWN0b3J5IGluc3RhbmNlLlxuICogQHNpbmNlIDQvOS8xOFxuICogQGZpbGVcbiAqL1xuXG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuXG5pbXBvcnQge1xuICBOT0RFX0VOVixcbiAgU09DS0VUX0VWRU5UUyxcbn0gZnJvbSAnLi9jb25zdGFudHMnO1xuXG5jb25zdCBsb2cgPSBkZWJ1Zygnbm9kZS1mYWN0b3J5OmV2ZW50cycpO1xuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuY29uc3QgaW5zcGVjdCA9IHZhbHVlID0+IGNvbnNvbGUubG9nKHV0aWwuaW5zcGVjdCh2YWx1ZSwgeyBjb2xvcnM6IHRydWUsIGRlcHRoOiAxMCB9KSk7XG5cbi8qKlxuICogRGlzcGF0Y2hlcyB0aGUgZXJyb3IgZXZlbnQgd2hlbiBhbnkgaW5jb21pbmcgbWVzc2FnZSBmYWlscyB0byBwcm9jZXNzLlxuICogVGhpcyBldmVudCBjYW4gYmUgaG9va2VkIGludG8gdG8gXCJ0b2FzdFwiIGVycm9yIG1lc3NhZ2VzIG9uIHRoZSBmcm9udC1lbmQuXG4gKiBAcGFyYW0ge29iamVjdH0gc29ja2V0IFRoZSBzb2NrZXQgY29ubmVjdGlvbiBoYW5kbGVyIGluIHdoaWNoIHRoZSBlcnJvciBvY2N1cnJlZC5cbiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudCBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgdGhhdCBmYWlsZWQgdG8gcHJvY2Vzcy5cbiAqIEBwYXJhbSB7RXJyb3J9IGVycm9yIFRoZSBlcnJvciB0aGF0IHdhcyB0aHJvd24gYnkgdGhlIGluY29taW5nIG1lc3NhZ2UgaGFuZGxlci5cbiAqIEBleHBvcnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZU5vZGVFdmVudEVycm9yKHNvY2tldCwgZXZlbnQsIGVycm9yKSB7XG4gIGxvZyhgU29ja2V0IEhhbmRsZXIgRXJyb3IgXCIke2V2ZW50fVwiOmAsIGVycm9yKTtcbiAgc29ja2V0LmVtaXQoU09DS0VUX0VWRU5UUy5FUlJPUiwgeyBldmVudCwgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG59XG5cbi8qKlxuICogQnJvYWRjYXN0cyB0aGUgbWVzc2FnZSBmcm9tIHRoZSB1c2VyIHRvIHRoZSByZXN0IG9mIHRoZSBjb25uZWN0ZWQgY2xpZW50cy5cbiAqIFRoaXMgZXhjbHVkZXMgdGhlIGNsaWVudCB3aG8gd2FzIHRoZSBvcmlnaW5hbCBzZW5kZXIgKHBlciBzb2NrZXQuaW8gZG9jcykuXG4gKiBAcGFyYW0ge29iamVjdH0gc29ja2V0IFRoZSBzb2NrZXQgY29ubmVjdGlvbiBoYW5kbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgY2FsbGJhY2suXG4gKiBAcGFyYW0ge3N0cmluZ30gZXZlbnQgVGhlIG5hbWUgb2YgdGhlIGV2ZW50IHRoYXQgY2FsbGJhY2sgd2lsbCBiZSBib3VuZCB0by5cbiAqIEBwYXJhbSB7b2JqZWN0fSBub2RlIFRoZSBkYXRhIHRvIGVtaXQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBicm9hZGNhc3RDaGlsZEV2ZW50KHNvY2tldCwgZXZlbnQsIG5vZGUpIHtcbiAgY29uc3Qga2V5ID0gYGNoaWxkLW9mLSR7bm9kZS5wYXJlbnR9LSR7ZXZlbnR9YDtcblxuICBsb2coYEJyb2FkY2FzdGluZyBTb2NrZXQgRXZlbnQgXCIke2tleX1cIjpgKTtcbiAgc29ja2V0LmJyb2FkY2FzdC5lbWl0KGtleSwgbm9kZSk7XG5cbiAgbG9nKGBCcm9hZGNhc3RpbmcgU29ja2V0IEV2ZW50IFwiJHtldmVudH1cIjpgLCBub2RlKTtcbiAgc29ja2V0LmJyb2FkY2FzdC5lbWl0KGV2ZW50LCBub2RlKTtcbn1cblxuLyoqXG4gKiBQcmVwYXJlcyBhbiBpbmNvbWluZyBzb2NrZXQgZXZlbnQgaGFuZGxlciBieSB3cmFwcGluZyB0aGUgZXZlbnQgaGFuZGxlciB0byBjYWxsIHRoZSByZXNwZWN0aXZlXG4gKiBub2RlIG9wZXJhdGlvbiwgYnJvYWRjYXN0IHRoZSBldmVudCB0byBhbGwgY29ubmVjdGVkIHVzZXJzLCBhbmQgYW5kIGVtaXRcbiAqIHRoZSBTT0NLRVRfRVZFTlRTLkVSUk9SIGV2ZW50IGlmIHRoZSBoYW5kbGVyIHRocm93cy5cbiAqXG4gKiBJdCBhbHNvIGxpbWl0cyB0aGUgaW50ZXJmYWNlIG9mIGVhY2ggcGFydGlhbGl6ZWQgbm9kZSBvcGVyYXRpb25cbiAqIHRvIHJlY2VpdmUgb25seSBhIHNpbmdsZSBvYmplY3QgKGJ5IGRlc2lnbikuXG4gKiBAcGFyYW0ge29iamVjdH0gc29ja2V0IFRoZSBzb2NrZXQgY29ubmVjdGlvbiBoYW5kbGVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgaGFuZGxlci5cbiAqIEBwYXJhbSB7b2JqZWN0fSBldmVudFNjaGVtYSBPcHRpb25zIGZvciB0aGlzIGdpdmVuIGV2ZW50LlxuICogQHBhcmFtIHtmdW5jdGlvbn0gZXZlbnRTY2hlbWEuaGFuZGxlciBUaGUgZXZlbnQgaGFuZGxlciB0aGF0IHdpbGwgYmUgaW52b2tlZCBvbiBcImV2ZW50XCIuXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGV2ZW50U2NoZW1hLmJyb2FkY2FzdCBJZiB0cnVlLCB0aGUgZXZlbnQgd2lsbCBiZVxuICogYnJvYWRjYXN0IHRvIGFsbCBvdGhlciBjb25uZWN0ZWQgY2xpZW50cy5cbiAqIEBwYXJhbSB7c3RyaW5nfSBldmVudCBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgdGhhdCBoYW5kbGVyIHdpbGwgYmUgYm91bmQgdG8uXG4gKiBAcmV0dXJucyB7ZnVuY3Rpb259IFRoZSB3cmFwcGVkIHNvY2tldCBldmVudCBoYW5kbGVyLlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZU5vZGVPcGVyYXRpb24oc29ja2V0LCBoYW5kbGVyLCBldmVudCkge1xuICByZXR1cm4gKGRhdGEpID0+IHtcbiAgICBsb2coYEluY29taW5nIFNvY2tldCBFdmVudCBcIiR7ZXZlbnR9XCI6YCwgZGF0YSk7XG5cbiAgICBjb25zdCBtYXliZUJyb2FkY2FzdENoaWxkRXZlbnQgPSAoeyBub2RlLCBicm9hZGNhc3QgfSkgPT4gKFxuICAgICAgYnJvYWRjYXN0ID8gYnJvYWRjYXN0Q2hpbGRFdmVudChzb2NrZXQsIGV2ZW50LCBub2RlKSA6IF8ubm9vcFxuICAgICk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgIC50aGVuKCgpID0+IGhhbmRsZXIoZGF0YSkpXG4gICAgICAudGhlbihtYXliZUJyb2FkY2FzdENoaWxkRXZlbnQpXG4gICAgICAuY2F0Y2goZSA9PiBoYW5kbGVOb2RlRXZlbnRFcnJvcihzb2NrZXQsIGV2ZW50LCBlKSk7XG4gIH07XG59XG5cbi8qKlxuICogUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHBhc3NlZCB0byB0aGUgd2Vic29ja2V0J3MgYG9uU29ja2V0Q29ubmVjdGlvbmBcbiAqIGNhbGxiYWNrLCBwcm92aWRlZCBhIE5vZGVGYWN0b3J5IGluc3RhbmNlLiBUaGlzIHdpbGwgc2V0dXAgdGhlIG5lY2Vzc2FyeSBzb2NrZXRcbiAqIGV2ZW50IGhhbmRsZXJzIGZvciBlYWNoIG9mIHRoZSBjb3JyZXNwb25kaW5nIG5vZGUgZmFjdG9yeSBDUlVEIG1ldGhvZHMuXG4gKiBAcGFyYW0ge29iamVjdH0gbm9kZXMgVGhlIE5vZGVGYWN0b3J5IHRvIG9wZXJhdGUgYWdhaW5zdCBhbmQgdG8gYmluZCB0byB0aGUgc29ja2V0IGNvbm5lY3Rpb24uXG4gKiBAcmV0dXJucyB7ZnVuY3Rpb259IEEgY2FsbGJhY2sgZm9yIHdlYnNvY2tldHMub25Tb2NrZXRDb25uZWN0aW9uLlxuICogQGV4cG9ydFxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBzZXR1cFdlYnNvY2tldEV2ZW50cyhub2Rlcykge1xuICByZXR1cm4gKHdlYnNvY2tldCwgc29ja2V0KSA9PiB7XG4gICAgLy8gQ29udmVuaWVuY2UgdG8gZHVtcCB0aGUgc3RvcmUncyBkYXRhXG4gICAgLy8gZm9yIGRlYnVnZ2luZyBwdXJwb3Nlcy5cbiAgICBpZiAoTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgc29ja2V0Lm9uKCdkdW1wJywgKCkgPT4gaW5zcGVjdChub2Rlcy5hbGwoKSkpO1xuXG4gICAgY29uc3QgZXZlbnRTY2hlbWEgPSB7XG4gICAgICBbU09DS0VUX0VWRU5UUy5IQVNfTk9ERV06IG5vZGVzLmhhcyxcbiAgICAgIFtTT0NLRVRfRVZFTlRTLkdFVF9OT0RFXTogbm9kZXMuZ2V0LFxuICAgICAgW1NPQ0tFVF9FVkVOVFMuU0VUX05PREVdOiBub2Rlcy5zZXQsXG4gICAgICBbU09DS0VUX0VWRU5UUy5ERUxfTk9ERV06IG5vZGVzLmRlbCxcbiAgICB9O1xuXG4gICAgXy5lYWNoKGV2ZW50U2NoZW1hLCAoc2NoZW1hLCBldmVudCkgPT4ge1xuICAgICAgc29ja2V0Lm9uKGV2ZW50LCBwcmVwYXJlTm9kZU9wZXJhdGlvbihzb2NrZXQsIHNjaGVtYSwgZXZlbnQpKTtcbiAgICB9KTtcbiAgfTtcbn1cbiJdfQ==